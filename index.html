<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Greenway Agencies Application</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- jsPDF (UMD, global variable) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; margin:0; background:#f0f2f5; }
.container { max-width:600px; margin:20px auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,.15); }
.header { text-align:center; margin-bottom:15px; }
.header img { max-height:60px; margin-bottom:8px; }
.header h1 { margin:0; font-size:26px; color:#1bd027; font-weight:bold; }
.block { margin-bottom:16px; }
.label { font-weight:bold; margin-bottom:8px; display:block; }
input, select, textarea { width:100%; padding:10px 12px; border-radius:6px; border:1px solid #999; font-size:14px; box-sizing:border-box; }
.row { display:flex; gap:10px; flex-wrap:wrap; }
.option { flex:1; text-align:center; padding:12px 0; border-radius:8px; cursor:pointer; font-weight:600; background:#f7f7f7; border:1px solid #ccc; min-width:80px; user-select:none; }
input[type="radio"], input[type="checkbox"] { display:none; }
input:checked + .option { background: linear-gradient(135deg,#10941f,#29ca13); color:#fff; border-color:#991194; }
.photo { border:2px dashed #999; border-radius:8px; padding:12px; text-align:center; cursor:pointer; }
.photo img { max-width:100%; border-radius:6px; margin-top:8px; }
button { width:100%; padding:14px; background:#44ca1e; color:#fff; font-size:16px; font-weight:bold; border:none; border-radius:8px; cursor:pointer; margin-top:12px; }
#ageDisplay { padding:12px; background:#f7f7f7; border-radius:8px; border:1px solid #ccc; font-weight:bold; text-align:center; }
.hidden { display:none; }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <img src="image.png" alt="Logo">
    <h1>GREENWAY AGENCIES (PVT) LTD</h1>
  </div>

  <!-- Token -->
  <div class="block"><div class="label">Token Number</div><input type="text" id="token"></div>

  <!-- Country -->
  <div class="block">
    <div class="label">Preferred Country</div>
    <select id="country">
      <option value="">Select Country</option>
      <option value="Kuwait">Kuwait</option>
      <option value="Dubai">Dubai</option>
      <option value="Oman">Oman</option>
      <option value="Bahrain">Bahrain</option>
      <option value="Qatar">Qatar</option>
      <option value="Cyprus">Cyprus</option>
      <option value="Singapore">Singapore</option>
    </select>
  </div>

  <!-- Full Name -->
  <div class="block"><div class="label">Full Name</div><input type="text" id="fullname"></div>

  <!-- Gender -->
  <div class="block">
    <div class="label">Gender</div>
    <div class="row">
      <label><input type="radio" name="gender" value="Male"><div class="option">Male</div></label>
      <label><input type="radio" name="gender" value="Female"><div class="option">Female</div></label>
    </div>
  </div>

  <!-- NIC + Age -->
  <div class="block" style="display:flex; gap:10px; align-items:flex-end;">
    <div style="flex:1;">
      <div class="label">NIC Number</div>
      <input type="text" id="nic" onkeyup="calculateAge()">
    </div>
    <div style="width:120px;">
      <div class="label">Age</div>
      <div id="ageDisplay">--</div>
    </div>
  </div>

  <!-- Passport -->
  <div class="block">
    <div class="label">Do you have a Passport?</div>
    <div class="row">
      <label><input type="radio" name="passport" value="Yes" onclick="togglePassport(true)"><div class="option">Yes</div></label>
      <label><input type="radio" name="passport" value="No" onclick="togglePassport(false)"><div class="option">No</div></label>
    </div>
    <div id="passportNumberBlock" class="hidden">
      <div class="label">Passport Number</div>
      <input type="text" id="passportNumber">
    </div>
    <div id="sixMonthsBlock" class="hidden">
      <div class="label">After 6 months?</div>
      <div class="row">
        <label><input type="radio" name="six_months" value="Yes"><div class="option">Yes</div></label>
        <label><input type="radio" name="six_months" value="No"><div class="option">No</div></label>
      </div>
    </div>
  </div>

  <!-- Abroad -->
  <div class="block">
    <div class="label">Have you been abroad?</div>
    <div class="row">
      <label><input type="radio" name="abroad" value="Yes"><div class="option">Yes</div></label>
      <label><input type="radio" name="abroad" value="No"><div class="option">No</div></label>
    </div>
  </div>

  <!-- Experience -->
  <div class="block">
    <div class="label">Experience</div>
    <div class="row">
      <label><input type="radio" name="experience" value="Experienced"><div class="option">Experienced</div></label>
      <label><input type="radio" name="experience" value="No Experience"><div class="option">No Experience</div></label>
    </div>
  </div>

  <!-- FBR & PR -->
  <div class="block">
    <div class="label">FBR & PR</div>
    <div class="row">
      <label><input type="radio" name="fbr_pr" value="Has"><div class="option">Has</div></label>
      <label><input type="radio" name="fbr_pr" value="Can Get"><div class="option">Can Get</div></label>
    </div>
  </div>

  <!-- Skills -->
  <div class="block">
    <div class="label">Skills</div>
    <div class="row">
      <label><input type="checkbox" value="Housekeeping"><div class="option">Housekeeping</div></label>
      <label><input type="checkbox" value="Cooking"><div class="option">Cooking</div></label>
      <label><input type="checkbox" value="Driving"><div class="option">Driving</div></label>
      <label><input type="checkbox" value="Caregiver"><div class="option">Caregiver</div></label>
      <label><input type="checkbox" value="Babysitting"><div class="option">Babysitting</div></label>
    </div>
  </div>

  <!-- Category -->
  <div class="block">
    <div class="label">Category</div>
    <div class="row">
      <label><input type="radio" name="category" value="GW"><div class="option">GW</div></label>
      <label><input type="radio" name="category" value="NPP"><div class="option">NPP</div></label>
    </div>
  </div>

  <!-- Phone -->
  <div class="block">
    <div class="label">Phone</div>
    <input type="text" id="phone">
  </div>

  <!-- Remark -->
  <div class="block">
    <div class="label">Remark</div>
    <textarea id="remark" rows="3"></textarea>
  </div>

  <!-- Photo -->
<div class="block">
  <div class="label">Photo</div>
  <div class="photo" onclick="document.getElementById('photoInput').click()">
    Tap to Open Camera
    <input
      id="photoInput"
      type="file"
      accept="image/*"
      capture="environment"
      hidden
      onchange="previewPhoto(event)"
    >
    <img id="photoPreview">
  </div>
</div>

  <button onclick="generatePDF()">Submit & Generate PDF</button>
</div>

<script>
/* ================= FUNCTIONS ================= */

// Preview Photo
function previewPhoto(e){
  const img = document.getElementById('photoPreview');
  img.src = URL.createObjectURL(e.target.files[0]);
  img.style.maxHeight = "120px";
}

// Calculate Age from NIC
function calculateAge(){
  const nic = document.getElementById('nic').value.trim();
  const ageBox = document.getElementById('ageDisplay');
  if(nic.length < 10){ ageBox.textContent = '--'; return; }
  let year = nic.length === 10 ? 1900 + parseInt(nic.substr(0,2)) : parseInt(nic.substr(0,4));
  ageBox.textContent = 2025 - year;
}

// Toggle Passport Fields
function togglePassport(show){
  document.getElementById('passportNumberBlock').style.display = show ? 'block' : 'none';
  document.getElementById('sixMonthsBlock').style.display = show ? 'block' : 'none';
  if(!show){
    document.getElementById('passportNumber').value="";
    document.querySelectorAll('input[name="six_months"]').forEach(r=>r.checked=false);
  }
}

// Save to Firebase
async function saveToFirebase(data){
  const { initializeApp } = await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js");
  const { getFirestore, collection, addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js");

  const firebaseConfig = {
    apiKey: "AIzaSyDvcMNKzfqdCSkWtYAQjGncB4if-Z9M2bg",
    authDomain: "green-tem-application.firebaseapp.com",
    projectId: "green-tem-application",
    storageBucket: "green-tem-application.appspot.com",
    messagingSenderId: "299339872716",
    appId: "1:299339872716:web:10e8e2472f64fd1f2ac569",
    measurementId: "G-P0FQ0SMFZ6"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  try { await addDoc(collection(db,"applications"),{...data,createdAt:serverTimestamp()}); console.log("Saved to Firebase"); }
  catch(err){ console.error(err); }
}

async function generatePDF(){
  const token = document.getElementById('token').value || '-';
  const country = document.getElementById('country').value || '-';
  const fullname = document.getElementById('fullname').value || '-';
  const gender = document.querySelector('input[name="gender"]:checked')?.value || '-';
  const nic = document.getElementById('nic').value || '-';
  const age = document.getElementById('ageDisplay').textContent || '-';
  const passport = document.querySelector('input[name="passport"]:checked')?.value || '-';
  const passportNo = passport === "Yes" ? document.getElementById('passportNumber').value || '-' : '-';
  const sixMonths = document.querySelector('input[name="six_months"]:checked')?.value || '-';
  const abroad = document.querySelector('input[name="abroad"]:checked')?.value || '-';
  const experience = document.querySelector('input[name="experience"]:checked')?.value || '-';
  const fbrpr = document.querySelector('input[name="fbr_pr"]:checked')?.value || '-';
  const category = document.querySelector('input[name="category"]:checked')?.value || '-';
  const skills = [...document.querySelectorAll('input[type="checkbox"]:checked')].map(i=>i.value).join(', ') || '-';
  const phone = document.getElementById('phone').value || '-';
  const remark = document.getElementById('remark').value || '-';
  const photoImg = document.getElementById('photoPreview');

  await saveToFirebase({token,country,fullname,gender,nic,age,passport,passportNo,sixMonths,abroad,experience,fbrpr,category,skills,phone,remark});

  const doc = new window.jspdf.jsPDF({unit:'pt',format:'a4'});
  const PAGE_WIDTH = doc.internal.pageSize.width;
  let y = 40;

  // ================= HEADER =================
  doc.setFillColor(24,180,36); // green gradient look
  doc.rect(0,0,PAGE_WIDTH,60,'F');
  doc.setTextColor(255,255,255);
  doc.setFontSize(22);
  doc.setFont("helvetica","bold");
  doc.text("GREENWAY AGENCIES (PVT) LTD", PAGE_WIDTH/2, 38, {align:'center'});

  y = 80;
  doc.setTextColor(0,0,0);
  doc.setFontSize(14);

  // ================= INFO BOX =================
const addRow = (label, value) => {
  const maxWidth = PAGE_WIDTH - 220; // space for value text
  const wrappedText = doc.splitTextToSize(String(value), maxWidth);

  const rowHeight = Math.max(28, wrappedText.length * 16 + 10);

  // Background
  doc.setFillColor(245,245,245);
  doc.roundedRect(40, y, PAGE_WIDTH-80, rowHeight, 6, 6, 'F');

  // Label
  doc.setFont("helvetica","bold");
  doc.setTextColor(90,90,90);
  doc.text(label, 50, y + 18);

  // Value
  doc.setFont("helvetica","normal");
  doc.setTextColor(0,0,0);
  doc.text(wrappedText, 200, y + 18);

  y += rowHeight + 10;

  // Auto page break
  if (y > 720) {
    doc.addPage();
    y = 60;
  }
};

  addRow("Token", token);
  addRow("Country", country);
  addRow("Full Name", fullname);
  addRow("Gender", gender);
  addRow("NIC", nic);
  addRow("Age", age);
  addRow("Passport", passport);
  addRow("Passport No", passportNo);
  addRow("6 Months?", sixMonths);
  addRow("Been Abroad", abroad);
  addRow("Experience", experience);
  addRow("FBR & PR", fbrpr);
  addRow("Category", category);
  addRow("Skills", skills);
  addRow("Phone", phone);
  addRow("Remark", remark);

  // ================= PHOTO =================
  if(photoImg && photoImg.src){
    const imgData = await new Promise(resolve=>{
      const img = new Image();
      img.crossOrigin='anonymous';
      img.onload = ()=>{ 
        const c=document.createElement('canvas'); 
        c.width=img.width; c.height=img.height; 
        c.getContext('2d').drawImage(img,0,0); 
        resolve(c.toDataURL('image/png')); 
      };
      img.src = photoImg.src;
    });
    doc.addImage(imgData,'PNG', PAGE_WIDTH-160, 80, 120, 150);
  }

  // ================= FOOTER =================
  doc.setDrawColor(200,200,200);
  doc.setLineWidth(0.5);
  doc.line(40, 780, PAGE_WIDTH-40, 780);
  doc.setFontSize(10);
  doc.setTextColor(120,120,120);
  doc.text("Generated by Greenway Agencies Application System", PAGE_WIDTH/2, 795, {align:'center'});

  doc.save(`${token}_${country}_Application.pdf`);
  alert("PDF Generated & Data Saved!");


  // Reset form
  document.querySelectorAll('input,textarea,select').forEach(el=>{
    if(el.type==="radio"||el.type==="checkbox") el.checked=false;
    else el.value="";
  });
  document.getElementById('ageDisplay').textContent="--";
  document.getElementById('photoPreview').src="";
}
</script>

</body>
</html>
